SELECT * FROM
(SELECT PM.INVENTORY_NUMBER, PM.TITLE_PRINTED_MATERIAL AS "Наименование книги",
LISTAGG (G.VALUE,  ', ') WITHIN GROUP (ORDER BY G.VALUE) AS "Жанр", AG.VALUE AS "Возрастное ограничение", 
LISTAGG (DISTINCT(A.LAST_NAME || ' ' || A.FIRST_NAME_PATRONYMIC),  ', ') WITHIN GROUP (ORDER BY (A.LAST_NAME || ' ' || A.FIRST_NAME_PATRONYMIC)) AS "ФИО автора"
FROM PRINTED_MATERIAL PM LEFT OUTER JOIN GENRE_PRINTED_MATERIAL G_PM
ON PM.ID = G_PM.ID_PRINTED_MATERIAL
LEFT OUTER JOIN GENRE G
ON G_PM.ID_GENRE = G.ID
JOIN AGE_RESTRICTION AG
ON PM.ID_AGE_RESTRICTION = AG.ID
JOIN AUTHOR_PRINTED_MATERIAL A_PM
ON PM.ID = A_PM.ID_PRINTED_MATERIAL
JOIN AUTHOR A
ON A_PM.ID_AUTHOR = A.ID
WHERE (A.ID_VIEW_ACTIVITY_AUTHOR = 1 OR A.ID_VIEW_ACTIVITY_AUTHOR = 3) -- автор ПМ - писатель/автор, т.к. есть еще иллюстратор
GROUP BY PM.INVENTORY_NUMBER, PM.TITLE_PRINTED_MATERIAL, AG.VALUE) T
WHERE LOWER (T."ФИО автора") LIKE '%сутеев%'; -- вопрос 1, ПМ автор Сутеев


SELECT * FROM
(SELECT PM.INVENTORY_NUMBER, PM.TITLE_PRINTED_MATERIAL AS "Наименование книги",
LISTAGG (G.VALUE,  ', ') WITHIN GROUP (ORDER BY G.VALUE) AS "Жанр", 
AG.VALUE AS "Возрастное ограничение", 
LISTAGG (DISTINCT(A.LAST_NAME || ' ' || A.FIRST_NAME_PATRONYMIC),  ', ') WITHIN GROUP (ORDER BY (A.LAST_NAME || ' ' || A.FIRST_NAME_PATRONYMIC)) AS "ФИО автора",
PH.TITLE_PUBLISHING_HOUSE AS "Издательство", PM.RELEASE_DATE AS "Дата выпуска"
FROM PRINTED_MATERIAL PM LEFT OUTER JOIN GENRE_PRINTED_MATERIAL G_PM
ON PM.ID = G_PM.ID_PRINTED_MATERIAL
LEFT OUTER JOIN GENRE G
ON G_PM.ID_GENRE = G.ID
JOIN AGE_RESTRICTION AG
ON PM.ID_AGE_RESTRICTION = AG.ID
JOIN AUTHOR_PRINTED_MATERIAL A_PM
ON PM.ID = A_PM.ID_PRINTED_MATERIAL
JOIN AUTHOR A
ON A_PM.ID_AUTHOR = A.ID
JOIN PUBLISHING_HOUSE_PRINTED_MATERIAL PH_PM
ON PM.ID = PH_PM.ID_PRINTED_MATERIAL
JOIN PUBLISHING_HOUSE PH
ON PH_PM.ID_PUBLISHING_HOUSE = PH.ID
WHERE (A.ID_VIEW_ACTIVITY_AUTHOR = 1 OR A.ID_VIEW_ACTIVITY_AUTHOR = 3) -- автор ПМ - писатель/автор, т.к. есть еще иллюстратор
GROUP BY PM.INVENTORY_NUMBER, PM.TITLE_PRINTED_MATERIAL, AG.VALUE, PH.TITLE_PUBLISHING_HOUSE, PM.RELEASE_DATE) T
WHERE UPPER (T."Издательство") LIKE '%АСТ_'
AND T."Дата выпуска" < TO_DATE ('01/10/2020', 'DD/MM/YYYY'); -- вопрос 2, ПМ издательства OOO "Издательство АСТ" выпущенных ранее 01.10.2020


SELECT * FROM
(SELECT PM.INVENTORY_NUMBER, PM.TITLE_PRINTED_MATERIAL AS "Наименование книги",
LISTAGG (DISTINCT G.VALUE, ', ') WITHIN GROUP (ORDER BY G.VALUE) AS "Жанр", 
LISTAGG (DISTINCT TAG.VALUE, ', ') WITHIN GROUP (ORDER BY TAG.VALUE) AS "Тег", 
LISTAGG (DISTINCT(A.LAST_NAME || ' ' || A.FIRST_NAME_PATRONYMIC),  ', ') WITHIN GROUP (ORDER BY (A.LAST_NAME || ' ' || A.FIRST_NAME_PATRONYMIC)) AS "ФИО автора", 
AG.VALUE AS "Возрастное ограничение", 
LISTAGG (DISTINCT C.TITLE_CREATION,  ', ') WITHIN GROUP (ORDER BY C.TITLE_CREATION) AS "Наименование произведений в книге"
FROM PRINTED_MATERIAL PM JOIN CREATION_PRINTED_MATERIAL C_PM
ON PM.ID = C_PM.ID_PRINTED_MATERIAL
JOIN CREATION C
ON C_PM.ID_CREATION = C.ID
LEFT OUTER JOIN GENRE_PRINTED_MATERIAL G_PM
ON PM.ID = G_PM.ID_PRINTED_MATERIAL
LEFT OUTER JOIN GENRE G
ON G_PM.ID_GENRE = G.ID
JOIN AGE_RESTRICTION AG
ON PM.ID_AGE_RESTRICTION = AG.ID
JOIN AUTHOR_PRINTED_MATERIAL A_PM
ON PM.ID = A_PM.ID_PRINTED_MATERIAL
JOIN AUTHOR A
ON A_PM.ID_AUTHOR = A.ID
LEFT OUTER JOIN TAG_PRINTED_MATERIAL TAG_PM
ON PM.ID = TAG_PM.ID_PRINTED_MATERIAL
LEFT OUTER JOIN TAG
ON TAG_PM.ID_TAG = TAG.ID
WHERE (A.ID_VIEW_ACTIVITY_AUTHOR = 1 OR A.ID_VIEW_ACTIVITY_AUTHOR = 3) -- автор ПМ - писатель/автор, т.к. есть еще иллюстратор
GROUP BY PM.INVENTORY_NUMBER, PM.TITLE_PRINTED_MATERIAL, AG.VALUE) T
WHERE UPPER (NVL (T."Жанр", ' ')) LIKE '%УЧЕБ%'
AND UPPER (NVL (T."Тег", ' ')) LIKE '%ШКОЛА%'
AND UPPER (T."ФИО автора") LIKE '%ВИН%'
AND T."Возрастное ограничение" = '6+';-- вопрос 3


SELECT TT.TITLE_PRINTED_MATERIAL AS "Название книги", TT.FULL_NAME_AUTHOR AS "ФИО автора", TT.RATING
FROM
(SELECT T.TITLE_PRINTED_MATERIAL, T.FULL_NAME_AUTHOR, T.GENRE, T.AGE_RESTRICTION,
RANK () OVER (ORDER BY COUNT (T.TITLE_PRINTED_MATERIAL) DESC) AS RATING
FROM
(SELECT PM.INVENTORY_NUMBER, PM.TITLE_PRINTED_MATERIAL,
LISTAGG (DISTINCT(A.LAST_NAME || ' ' || A.FIRST_NAME_PATRONYMIC),  ', ') WITHIN GROUP (ORDER BY (A.LAST_NAME || ' ' || A.FIRST_NAME_PATRONYMIC)) AS FULL_NAME_AUTHOR,
PH.TITLE_PUBLISHING_HOUSE, 
LISTAGG (DISTINCT (G.VALUE), ', ') WITHIN GROUP (ORDER BY G.VALUE) AS GENRE, AG_R.VALUE AS AGE_RESTRICTION, ISS_LOG.DATE_ISSUE_PRINTED_MATERIAL
FROM PRINTED_MATERIAL PM JOIN ISSUE_AND_RETURN_LOG_PRINTED_MATERIAL ISS_LOG
ON PM.ID = ISS_LOG.ID_PRINTED_MATERIAL
JOIN AUTHOR_PRINTED_MATERIAL A_PM
ON PM.ID = A_PM.ID_PRINTED_MATERIAL
JOIN AUTHOR A
ON A_PM.ID_AUTHOR = A.ID
JOIN PUBLISHING_HOUSE_PRINTED_MATERIAL PH_PM
ON PM.ID = PH_PM.ID_PRINTED_MATERIAL
JOIN PUBLISHING_HOUSE PH
ON PH_PM.ID_PUBLISHING_HOUSE = PH.ID
LEFT JOIN GENRE_PRINTED_MATERIAL G_PM
ON PM.ID = G_PM.ID_PRINTED_MATERIAL
LEFT JOIN GENRE G
ON G_PM.ID_GENRE = G.ID
JOIN AGE_RESTRICTION AG_R
ON PM.ID_AGE_RESTRICTION = AG_R.ID
WHERE (A.ID_VIEW_ACTIVITY_AUTHOR = 1 OR A.ID_VIEW_ACTIVITY_AUTHOR = 3) -- автор ПМ - писатель/автор, т.к. есть еще иллюстратор
GROUP BY PM.INVENTORY_NUMBER, PM.TITLE_PRINTED_MATERIAL, PH.TITLE_PUBLISHING_HOUSE, AG_R.VALUE, 
ISS_LOG.DATE_ISSUE_PRINTED_MATERIAL) T
GROUP BY T.TITLE_PRINTED_MATERIAL, T.FULL_NAME_AUTHOR, T.GENRE, T.AGE_RESTRICTION) TT
WHERE TT.RATING <= 5; -- вопрос 4, ТОП 5 самых популярных книг по кол-ву выдачи.


SELECT TT.FULL_NAME_READER AS "ФИО Читателя", TT.LIBRARY_CARD_NUMBER AS "Читательский билет", TT.RATING
FROM
(SELECT T.FULL_NAME_READER, T.LIBRARY_CARD_NUMBER,
RANK () OVER (ORDER BY COUNT (T.FULL_NAME_READER) DESC) AS RATING
FROM
(SELECT PM.INVENTORY_NUMBER, ISS_LOG.DATE_ISSUE_PRINTED_MATERIAL, (R.LAST_NAME || ' ' || R.FIRST_NAME_PATRONYMIC) AS FULL_NAME_READER,
R.LIBRARY_CARD_NUMBER
FROM PRINTED_MATERIAL PM JOIN ISSUE_AND_RETURN_LOG_PRINTED_MATERIAL ISS_LOG
ON PM.ID = ISS_LOG.ID_PRINTED_MATERIAL
JOIN READER R
ON ISS_LOG.ID_READER = R.ID
GROUP BY PM.INVENTORY_NUMBER, ISS_LOG.DATE_ISSUE_PRINTED_MATERIAL, (R.LAST_NAME || ' ' || R.FIRST_NAME_PATRONYMIC), R.LIBRARY_CARD_NUMBER) T
WHERE T.DATE_ISSUE_PRINTED_MATERIAL BETWEEN TO_DATE ('01/10/2022', 'DD/MM/YYYY') AND TO_DATE ('30/09/2023', 'DD/MM/YYYY')
GROUP BY T.FULL_NAME_READER, T.LIBRARY_CARD_NUMBER) TT
WHERE TT.RATING <= 5; -- вопрос 5, ТОП 5 самых читающих пользователей за период с 01.10.2022 по 30.09.2023.


SELECT TT.TITLE_PRINTED_MATERIAL AS "Название книги", TT.FULL_NAME_AUTHOR AS "ФИО автора", TT.QUANTITY_PRINTED_MATERIAL
FROM
(SELECT T.TITLE_PRINTED_MATERIAL, T.FULL_NAME_AUTHOR, T.DATE_ISSUE_PRINTED_MATERIAL, T.DATE_RETURN, T.DATE_ISSUE_REFUSAL,
COUNT (T.TITLE_PRINTED_MATERIAL) AS QUANTITY_PRINTED_MATERIAL
FROM
(SELECT PM.INVENTORY_NUMBER, PM.TITLE_PRINTED_MATERIAL,
LISTAGG (DISTINCT(A.LAST_NAME || ' ' || A.FIRST_NAME_PATRONYMIC),  ', ') WITHIN GROUP (ORDER BY (A.LAST_NAME || ' ' || A.FIRST_NAME_PATRONYMIC)) AS FULL_NAME_AUTHOR,
ISS_LOG.DATE_ISSUE_PRINTED_MATERIAL, ISS_LOG.DATE_RETURN, ISS_LOG.DATE_ISSUE_REFUSAL
FROM PRINTED_MATERIAL PM LEFT JOIN ISSUE_AND_RETURN_LOG_PRINTED_MATERIAL ISS_LOG
ON PM.ID = ISS_LOG.ID_PRINTED_MATERIAL
JOIN AUTHOR_PRINTED_MATERIAL A_PM
ON PM.ID = A_PM.ID_PRINTED_MATERIAL
JOIN AUTHOR A
ON A_PM.ID_AUTHOR = A.ID
WHERE (A.ID_VIEW_ACTIVITY_AUTHOR = 1 OR A.ID_VIEW_ACTIVITY_AUTHOR = 3) -- автор ПМ - писатель/автор, т.к. есть еще иллюстратор
GROUP BY PM.INVENTORY_NUMBER, PM.TITLE_PRINTED_MATERIAL, ISS_LOG.DATE_ISSUE_PRINTED_MATERIAL, ISS_LOG.DATE_RETURN, ISS_LOG.DATE_ISSUE_REFUSAL) T
WHERE (T.DATE_ISSUE_PRINTED_MATERIAL IS NOT NULL AND T.DATE_RETURN IS NULL) OR (T.DATE_ISSUE_PRINTED_MATERIAL IS NULL AND T.DATE_ISSUE_REFUSAL IS NULL)
GROUP BY T.TITLE_PRINTED_MATERIAL, T.FULL_NAME_AUTHOR, T.DATE_ISSUE_PRINTED_MATERIAL, T.DATE_RETURN, T.DATE_ISSUE_REFUSAL) TT
WHERE TT.QUANTITY_PRINTED_MATERIAL < 2; -- вопрос 6, найти список книг которые не могут быть выданы читателю домой.

