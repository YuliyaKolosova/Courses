CREATE OR REPLACE VIEW PM_TOP_10
(TITLE_PRINTED_MATERIAL, FULL_NAME_AUTHOR, AGE_RESTRICTION, GENRE, RATING)
AS SELECT * FROM
(SELECT T.TITLE_PRINTED_MATERIAL, T.FULL_NAME_AUTHOR, T.GENRE, T.AGE_RESTRICTION,
RANK () OVER (ORDER BY COUNT (T.TITLE_PRINTED_MATERIAL) DESC) AS RATING
FROM
(SELECT PM.INVENTORY_NUMBER, PM.TITLE_PRINTED_MATERIAL,
LISTAGG (DISTINCT(A.LAST_NAME || ' ' || A.FIRST_NAME_PATRONYMIC),  ', ') WITHIN GROUP 
(ORDER BY (A.LAST_NAME || ' ' || A.FIRST_NAME_PATRONYMIC)) AS FULL_NAME_AUTHOR,
PH.TITLE_PUBLISHING_HOUSE, 
LISTAGG (DISTINCT (G.VALUE), ', ') WITHIN GROUP (ORDER BY G.VALUE) AS GENRE, 
AG_R.VALUE AS AGE_RESTRICTION, ISS_LOG.DATE_ISSUE_PRINTED_MATERIAL
FROM PRINTED_MATERIAL PM JOIN ISSUE_AND_RETURN_LOG_PRINTED_MATERIAL ISS_LOG
ON PM.ID = ISS_LOG.ID_PRINTED_MATERIAL
JOIN AUTHOR_PRINTED_MATERIAL A_PM
ON PM.ID = A_PM.ID_PRINTED_MATERIAL
JOIN AUTHOR A
ON A_PM.ID_AUTHOR = A.ID
JOIN PUBLISHING_HOUSE_PRINTED_MATERIAL PH_PM
ON PM.ID = PH_PM.ID_PRINTED_MATERIAL
JOIN PUBLISHING_HOUSE PH
ON PH_PM.ID_PUBLISHING_HOUSE = PH.ID
LEFT JOIN GENRE_PRINTED_MATERIAL G_PM
ON PM.ID = G_PM.ID_PRINTED_MATERIAL
LEFT JOIN GENRE G
ON G_PM.ID_GENRE = G.ID
JOIN AGE_RESTRICTION AG_R
ON PM.ID_AGE_RESTRICTION = AG_R.ID
WHERE (A.ID_VIEW_ACTIVITY_AUTHOR = 1 OR A.ID_VIEW_ACTIVITY_AUTHOR = 3) -- автор ПМ - писатель/автор, т.к. есть еще иллюстратор
GROUP BY PM.INVENTORY_NUMBER, PM.TITLE_PRINTED_MATERIAL, PH.TITLE_PUBLISHING_HOUSE, AG_R.VALUE, 
ISS_LOG.DATE_ISSUE_PRINTED_MATERIAL) T
GROUP BY T.TITLE_PRINTED_MATERIAL, T.FULL_NAME_AUTHOR, T.GENRE, T.AGE_RESTRICTION)
WHERE RATING <= '10'; -- ТОП 10 самых популярных книг по кол-ву выдачи.


CREATE OR REPLACE VIEW READER_TOP_10_DATE
(FULL_NAME_READER, LIBRARY_CARD_NUMBER, RATING)
AS SELECT TT.FULL_NAME_READER , TT.LIBRARY_CARD_NUMBER, TT.RATING
FROM
(SELECT T.FULL_NAME_READER, T.LIBRARY_CARD_NUMBER,
RANK () OVER (ORDER BY COUNT (T.FULL_NAME_READER) DESC) AS RATING
FROM
(SELECT PM.INVENTORY_NUMBER, ISS_LOG.DATE_ISSUE_PRINTED_MATERIAL, 
(R.LAST_NAME || ' ' || R.FIRST_NAME_PATRONYMIC) AS FULL_NAME_READER,
R.LIBRARY_CARD_NUMBER
FROM PRINTED_MATERIAL PM JOIN ISSUE_AND_RETURN_LOG_PRINTED_MATERIAL ISS_LOG
ON PM.ID = ISS_LOG.ID_PRINTED_MATERIAL
JOIN READER R
ON ISS_LOG.ID_READER = R.ID
GROUP BY PM.INVENTORY_NUMBER, ISS_LOG.DATE_ISSUE_PRINTED_MATERIAL, 
(R.LAST_NAME || ' ' || R.FIRST_NAME_PATRONYMIC), R.LIBRARY_CARD_NUMBER) T
WHERE T.DATE_ISSUE_PRINTED_MATERIAL BETWEEN TO_DATE ('01/10/2022', 'DD/MM/YYYY') 
AND TO_DATE ('30/09/2023', 'DD/MM/YYYY')
GROUP BY T.FULL_NAME_READER, T.LIBRARY_CARD_NUMBER) TT
WHERE RATING <= 10; -- ТОП 10 самых читающих пользователей за период с 01.10.2022 по 30.09.2023.




